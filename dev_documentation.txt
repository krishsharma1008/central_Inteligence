===============================================================================
DEVELOPMENT DOCUMENTATION - Central Intelligence Email Processing MCP Server
===============================================================================

-------------------------------------------------------------------------------
UPDATE: Wednesday, December 17, 2025 - 10:33 PM IST
-------------------------------------------------------------------------------

## Git Push: Attachment Handlers and Document Extractors Update

### Summary
Pushed updates to attachment handling and document extraction modules, along with database synchronization.

### Changes Pushed
- **.gitignore**: Removed C:/ pattern (cleanup)
- **data/emails.db**: Database updates (593KB -> 708KB)
- **src/attachments/attachment_handler.py**: Enhanced attachment handling (+44 lines modified)
- **src/attachments/document_extractors.py**: Improved document extraction capabilities (+160 lines modified)

### Commit Details
- **Commit Hash**: a1f1ea1
- **Commit Message**: "Update: attachment handlers, document extractors, and database sync"
- **Files Changed**: 4 files, 191 insertions(+), 15 deletions(-)
- **Remote**: https://github.com/krishsharma1008/central_Inteligence.git
- **Branch**: main

### Verification
- Local branch is up to date with origin/main
- Working tree is clean
- All changes successfully pushed to remote repository

-------------------------------------------------------------------------------
UPDATE: Wednesday, December 17, 2025 - 10:28 PM IST
-------------------------------------------------------------------------------

## Repository Cleanup: Remove C:/ Folder

### Summary
Removed the accidentally tracked Windows path folder (`C:/`) from the git repository and added it to `.gitignore` to prevent future tracking.

### Changes Made
- **Removed from git**: `C:/Users/ShreyesPrabhuDesai/PersProjects/central_Inteligence/data/emails.db`
- **Updated .gitignore**: Added `C:/` pattern to prevent Windows paths from being tracked
- **Commit Hash**: 35c0d22
- **Commit Message**: "Remove C:/ folder from repository and add to .gitignore"

### Rationale
Windows absolute paths should not be tracked in git repositories as they are:
- Machine-specific and not portable
- Can cause issues when cloning on different operating systems
- Not relevant to the project structure

### Verification
- No C:/ files remain in git tracking
- .gitignore updated to prevent future additions
- Changes successfully pushed to origin/main

## Git Push Operation

### Summary
Successfully pushed all local changes to the remote repository (origin/main).

### Changes Pushed
- **data/emails.db**: Database updates (536KB -> 593KB)
- **dev_documentation.txt**: Documentation updates (+117 lines)
- **src/GraphConnector.py**: Minor modifications
- **src/web_api.py**: Added improvements (+4 lines)

### Commit Details
- **Commit Hash**: 326998f
- **Commit Message**: "Update: GraphConnector and web_api improvements, documentation updates, and database sync"
- **Files Changed**: 4 files, 123 insertions(+), 2 deletions(-)
- **Remote**: https://github.com/krishsharma1008/central_Inteligence.git
- **Branch**: main

### Verification
- Local branch is up to date with origin/main
- Working tree is clean
- Code is ready to be pulled from remote repository

-------------------------------------------------------------------------------
UPDATE: Monday, December 15, 2025 - 12:34 PM IST
-------------------------------------------------------------------------------

## Major Architecture Overhaul: IMAP Integration & Sarvam AI Implementation

### Summary
Completed a comprehensive migration from Windows-only Outlook COM connector to 
cross-platform IMAP-based email access, and replaced Ollama with Sarvam AI for 
embeddings and email analysis. This makes the system platform-independent and 
adds intelligent email analysis capabilities.

### Changes Implemented

#### 1. Dependencies Update (pyproject.toml)
- REMOVED: langchain-ollama, pywin32 (Windows-only), langchain, langchain_core, 
  langchain-community
- ADDED: imapclient (IMAP support), requests (HTTP client for API calls)
- RETAINED: pymongo, fastmcp, pydantic, pytz, python-dotenv
- Result: Reduced dependencies and cross-platform compatibility

#### 2. New IMAP Email Connector (src/IMAPConnector.py)
Created comprehensive IMAP connector with following features:
- SSL/TLS connection to Outlook/Office 365 (port 993)
- Email authentication via app passwords
- Date range filtering for email retrieval
- MIME header decoding for international characters
- Email body extraction (text/plain and text/html)
- Email metadata parsing (subject, sender, recipients, date)
- Compatibility layer with existing EmailMetadata structure
- Automatic connection management and cleanup
- Retry logic for connection failures

Key Methods:
- connect(): Establishes IMAP connection with retry logic
- disconnect(): Safely closes IMAP connection
- get_emails_within_date_range(): Retrieves emails from inbox with date filtering
- decode_mime_header(): Handles encoded email headers
- clean_email_body(): Sanitizes email content for storage
- parse_date(): Converts email dates to UTC datetime objects

#### 3. Sarvam AI Client Integration (src/SarvamClient.py)
Created new client wrapper for Sarvam AI API with:
- Embeddings generation (currently using fallback method until API available)
- Email analysis using chat/completions endpoint
- Structured analysis output:
  * Summary (2-3 sentences)
  * Key points (bullet format)
  * Sentiment analysis (positive/negative/neutral)
  * Category classification (work/personal/spam/marketing)
  * Action items extraction
- Retry logic with exponential backoff
- Rate limiting protection
- Error handling with fallback responses
- Batch processing capabilities

API Endpoints Used:
- POST /chat/completions: Email analysis and summarization
- (Future) POST /embeddings: Vector embeddings generation

#### 4. Embedding Processor Refactor (src/tools/embedding_processor.py)
Modified to use Sarvam AI instead of Ollama:
- Updated __init__ to accept sarvam_api_key parameter
- Replaced OllamaEmbeddings with SarvamClient
- Added email analysis to process_batch() method
- Integrated analysis results into metadata before MongoDB storage
- Maintained backward compatibility with existing data structure
- Enhanced error handling for API failures

#### 5. Main Server Configuration Update (src/mcp_server.py)
Comprehensive updates to server initialization and configuration:

Dependencies:
- Replaced OutlookConnector with IMAPConnector
- Removed langchain_ollama imports
- Added SarvamClient import

Configuration Validation:
- New required env vars: SARVAM_API_KEY, EMAIL_ADDRESS, EMAIL_PASSWORD
- Removed: EMBEDDING_BASE_URL, EMBEDDING_MODEL, PROCESS_DELETED_ITEMS
- Added optional: IMAP_SERVER (default: outlook.office365.com), IMAP_PORT (default: 993)

EmailProcessor Class:
- Replaced Outlook COM connector with IMAP connector
- Updated initialization to pass Sarvam API key to embedding processor
- Modified email retrieval to use IMAP
- Simplified to inbox-only processing (removed multi-mailbox support)
- Added IMAP connect/disconnect in process_emails workflow

Email Processing Flow:
1. Connect to IMAP server
2. Retrieve emails from inbox only (no Sent Items or Deleted Items)
3. Store emails in SQLite
4. Generate embeddings via Sarvam AI
5. Analyze emails via Sarvam AI
6. Store embeddings and analysis in MongoDB
7. Mark emails as processed
8. Disconnect from IMAP

Cleanup:
- Added IMAP disconnection to cleanup_resources handler
- Maintained existing SQLite and MongoDB cleanup

#### 6. MongoDB Schema Extension (src/MongoDBHandler.py)
Enhanced to store email analysis results:
- Modified metadata sanitization to preserve 'analysis' dict structure
- Analysis field contains JSON object with:
  * summary: string
  * key_points: array
  * sentiment: string
  * category: string
  * action_items: array
- Maintained backward compatibility with existing documents
- Added special handling for nested analysis object

#### 7. Comprehensive Documentation Update (README.md)
Complete rewrite of documentation including:

Prerequisites:
- Updated to reflect cross-platform support (macOS, Linux, Windows)
- Removed Ollama and Windows-only requirements
- Added Sarvam AI API key requirement
- Added IMAP access and app password requirements

Installation:
- Removed Ollama setup steps
- Added detailed IMAP setup guide for Outlook/Office 365
- Added app password creation instructions
- Added Sarvam AI API key acquisition guide

Configuration:
- Provided separate examples for Windows and macOS/Linux
- Updated environment variables with new requirements
- Added security notes about credential management
- Included example with actual configuration structure

Features:
- Updated to highlight inbox-only processing
- Added email analysis capabilities description
- Removed multi-mailbox support references
- Added cross-platform compatibility notes

Architecture:
- Documented IMAP connector role
- Explained Sarvam AI integration
- Added data flow diagram
- Described hybrid storage approach (SQLite + MongoDB)

Debugging:
- Added IMAP-specific troubleshooting
- Added Sarvam AI debugging steps
- Included IMAP connection test script
- Enhanced error handling documentation

Security:
- Added app password best practices
- Documented SSL/TLS encryption
- Included credential management guidelines
- Added two-factor authentication recommendations

### Configuration Changes

Old Environment Variables:
- EMBEDDING_BASE_URL
- EMBEDDING_MODEL
- PROCESS_DELETED_ITEMS

New Environment Variables:
- SARVAM_API_KEY: sk_mghaeht5_ilQquPT4b9KSkC4iIlfRLfwZ
- EMAIL_ADDRESS: User's Outlook/Office 365 email
- EMAIL_PASSWORD: App-specific password for IMAP
- IMAP_SERVER: outlook.office365.com (default)
- IMAP_PORT: 993 (default)

Retained Variables:
- MONGODB_URI
- SQLITE_DB_PATH
- COLLECTION_NAME

### Benefits of Changes

1. **Cross-Platform Compatibility**
   - Works on macOS, Linux, and Windows
   - No dependency on Windows-specific COM objects
   - Standard IMAP protocol support

2. **Enhanced Security**
   - App-specific passwords instead of main account password
   - SSL/TLS encrypted IMAP connections
   - Two-factor authentication support

3. **Intelligent Analysis**
   - Automatic email summarization
   - Sentiment analysis
   - Category classification
   - Action item extraction
   - Structured analysis storage

4. **Simplified Processing**
   - Inbox-only focus reduces complexity
   - Single mailbox configuration
   - Clearer user experience

5. **Better Error Handling**
   - Retry logic for network issues
   - Fallback responses for API failures
   - Detailed error messages

6. **Scalability**
   - API-based embeddings (no local model required)
   - Cloud-based processing
   - Rate limiting protection

### Testing Recommendations

1. Test IMAP connection with valid Outlook credentials
2. Verify Sarvam AI API key authentication
3. Test email retrieval with various date ranges
4. Validate embedding generation
5. Verify email analysis results structure
6. Test MongoDB storage of analysis data
7. Verify SQLite processing status tracking
8. Test connection cleanup on shutdown
9. Validate cross-platform functionality

### Migration Notes for Users

Users migrating from previous version need to:
1. Obtain Sarvam AI API key from dashboard.sarvam.ai
2. Enable IMAP in Outlook settings
3. Create app password for IMAP access
4. Update configuration with new environment variables
5. Remove Ollama-related configuration
6. Update Python dependencies (uv pip install -e .)

### Known Limitations

1. Sarvam AI embeddings API not yet publicly available
   - Currently using fallback embedding method
   - Will be updated when API becomes available

2. Analysis API rate limits
   - May need to implement request queuing for large volumes
   - Consider batch size adjustments if rate limited

3. IMAP performance
   - May be slower than COM for very large inboxes
   - Date range filtering helps manage load

### Future Enhancements

1. Implement proper Sarvam embeddings when API available
2. Add semantic search capabilities
3. Implement email drafting assistance
4. Add rule suggestion based on patterns
5. Support additional email providers (Gmail, etc.)
6. Add caching for frequently accessed emails
7. Implement incremental sync

### Files Modified
- pyproject.toml
- src/mcp_server.py
- src/tools/embedding_processor.py
- src/MongoDBHandler.py
- README.md

### Files Created
- src/IMAPConnector.py
- src/SarvamClient.py

### Files Deprecated
- src/OutlookConnector.py (retained for reference, not actively used)

### Code Quality Notes
- All code follows existing patterns and conventions
- Comprehensive error handling with logging
- Type hints maintained throughout
- Docstrings provided for all new functions and classes
- Retry logic implemented for external services
- Resource cleanup handlers properly implemented

### Deployment Checklist
- [ ] Update production configuration with new environment variables
- [ ] Verify MongoDB is accessible
- [ ] Test IMAP connectivity to Outlook
- [ ] Validate Sarvam AI API key
- [ ] Update Claude Desktop configuration
- [ ] Test with small date range first
- [ ] Monitor logs for errors
- [ ] Verify email analysis results
- [ ] Check MongoDB storage structure

-------------------------------------------------------------------------------
UPDATE: Monday, December 16, 2025 - 2:15 PM IST
-------------------------------------------------------------------------------

## Thread-Aware RAG Implementation

### Summary
Implemented comprehensive thread-aware email retrieval and RAG system to enable natural language queries that understand full email conversation context. This addresses the issue where queries like "what happened with Hepstart" were failing because the system couldn't retrieve and understand complete email threads.

### Changes Implemented

#### 1. Graph API Connector Enhancement (src/GraphConnector.py)
Extended to fetch thread metadata and support full mailbox sync:
- Added fields to Graph API query: conversationId, conversationIndex, internetMessageId, inReplyTo, ccRecipients, replyTo, bodyPreview
- Implemented paging support: Automatically follows @odata.nextLink for large result sets
- Added sync_all_emails() method: Uses Graph delta query (/messages/delta) for efficient full mailbox history sync
- Stores and reuses deltaLink for incremental syncs
- Enhanced error handling for paging failures

Key Methods:
- get_emails(): Enhanced with paging and thread fields
- sync_all_emails(): New method for delta-based full sync
- Headers and authentication remain unchanged

#### 2. EmailMetadata Extension (src/EmailMetadata.py)
Added thread-related fields to email metadata:
- ConversationId: Microsoft Graph conversation identifier
- ConversationIndex: Position in conversation thread
- InternetMessageId: RFC 822 message ID
- InReplyTo: Reference to parent message
- CcRecipients: CC recipients as comma-separated string
- ReplyTo: Reply-to addresses
- BodyPreview: Short preview of email body

All fields are optional and backward-compatible with existing code.

#### 3. SQLite Schema Migration (src/SQLiteHandler.py)
Added thread support with backward-compatible migration:
- New columns: conversation_id, conversation_index, internet_message_id
- Migration uses ALTER TABLE IF NOT EXISTS pattern (safe for existing databases)
- New indices: idx_conversation_id, idx_conversation_time (for efficient thread queries)
- Updated search_emails_fts() to return conversation_id in results
- New method: get_emails_by_conversation_id() - fetches all messages in a thread
- New metadata table: Stores delta links and sync state
- New methods: get_metadata_value(), set_metadata_value() for sync state management

#### 4. MongoDB Metadata Extension (src/tools/embedding_processor.py)
Updated to store thread metadata in embedding documents:
- Added ConversationId, ConversationIndex, InternetMessageId to metadata dict
- Enables thread-aware vector reranking
- Maintains backward compatibility with existing documents

#### 5. Thread-Aware Query Service (src/rag/query_service.py)
Complete rewrite of query processing for thread awareness:

Enhanced Query Building:
- _build_enhanced_query(): Extracts keywords, handles variations, builds OR queries
- Better recall for queries like "hepstart" (also matches "hep start", etc.)
- Filters stop words and focuses on meaningful keywords

Thread Grouping and Retrieval:
- Groups FTS results by conversation_id
- Selects top threads by best match rank
- Fetches ALL messages in top threads (not just matching ones)
- Handles standalone emails (no conversation_id) gracefully

Thread Context Building:
- _build_thread_context(): New method that presents threads chronologically
- Shows thread structure with message numbering
- Larger body budget per message (1000 chars vs 500)
- Preserves conversation flow for LLM understanding

Updated Prompt:
- Instructs LLM to cite by thread and message number
- Emphasizes full conversation context
- Better instructions for synthesizing across threads

#### 6. Email Searcher Extension (src/rag/sqlite_search.py)
Added thread retrieval support:
- get_thread_emails(): Fetches all emails in a conversation thread
- Used by QueryService to get complete thread context

#### 7. MCP Server Tools (src/mcp_server.py)
Added new tools for full mailbox sync:
- sync_all_emails(): Full mailbox sync using Graph delta query
  - Stores delta link for future incremental syncs
  - Processes all emails with embeddings and analysis
  - Progress reporting support
- sync_incremental(): Incremental sync since last delta link
  - Fast updates for new/changed emails only
  - Automatically processes new embeddings

#### 8. Comprehensive Tests (tests/test_thread_rag.py)
New test suite covering:
- Enhanced query building with keyword extraction
- Thread grouping logic
- Thread context building
- EmailMetadata conversation fields
- Thread retrieval functionality

### Configuration Changes

New Environment Variables:
- None (all thread support is automatic)

Enhanced Behavior:
- Graph API now fetches thread metadata automatically
- SQLite automatically migrates schema on first use
- Query service automatically groups by threads
- No user configuration required

### Benefits of Changes

1. **Complete Context Understanding**
   - LLM sees full conversation threads, not isolated messages
   - Answers reflect complete thread history
   - Better understanding of email relationships

2. **Improved Recall**
   - Enhanced query building finds more relevant emails
   - Keyword extraction handles variations (e.g., "hepstart" vs "hep start")
   - Thread grouping ensures related messages are included

3. **Efficient Full Mailbox Sync**
   - Delta sync is more efficient than date-range queries
   - Incremental syncs are fast (only new/changed emails)
   - Automatic delta link management

4. **Backward Compatibility**
   - Existing databases automatically migrate
   - Old emails without conversation_id still work
   - No breaking changes to existing functionality

5. **Better User Experience**
   - Queries like "what happened with Hepstart" now work reliably
   - Answers include full conversation context
   - Citations reference complete threads

### Testing Recommendations

1. Test Graph API paging with large result sets
2. Verify delta sync stores and reuses delta links
3. Test thread grouping with various conversation structures
4. Validate enhanced query building with different question formats
5. Verify thread context includes all messages chronologically
6. Test backward compatibility with existing databases
7. Validate incremental sync only fetches new emails
8. Test queries with company names (e.g., "Hepstart")

### Migration Notes for Users

Users upgrading need to:
1. Run sync_all_emails() once to ingest full mailbox history with thread metadata
2. Existing emails will get thread fields on next update
3. No configuration changes required
4. Database will automatically migrate schema

### Known Limitations

1. Thread grouping requires conversationId from Graph API
   - Some old emails may not have conversationId
   - These are handled as standalone emails

2. Large threads may exceed token limits
   - Current limit: 1000 chars per message
   - Very long threads may be truncated

3. Delta sync requires Graph API permissions
   - Mail.Read permission required
   - Delta links expire after 7 days of inactivity

### Future Enhancements

1. Thread summarization for very long conversations
2. Smart thread selection (prioritize recent/important threads)
3. Cross-thread relationship detection
4. Thread visualization in UI
5. Conversation-level embeddings

### Files Modified
- src/GraphConnector.py
- src/EmailMetadata.py
- src/SQLiteHandler.py
- src/mcp_server.py
- src/tools/embedding_processor.py
- src/rag/query_service.py
- src/rag/sqlite_search.py
- README.md

### Files Created
- tests/test_thread_rag.py

### Code Quality Notes
- All changes maintain backward compatibility
- Comprehensive error handling and logging
- Type hints maintained throughout
- Docstrings provided for all new methods
- Migration logic is safe and idempotent
- Tests cover key functionality

### Deployment Checklist
- [ ] Test Graph API authentication with new fields
- [ ] Verify SQLite migration on existing databases
- [ ] Test sync_all_emails with full mailbox
- [ ] Validate thread grouping with real email data
- [ ] Test queries with company names (Hepstart, etc.)
- [ ] Verify incremental sync works correctly
- [ ] Check MongoDB metadata includes thread fields
- [ ] Monitor logs for any migration issues

-------------------------------------------------------------------------------
UPDATE: Tuesday, December 16, 2025 - 2:42 PM IST
-------------------------------------------------------------------------------

## Relevance Filtering for Citations

### Summary
Implemented keyword-based relevance filtering to ensure only emails that actually match the search query are included in citations. This fixes the issue where irrelevant emails (like "Test email") were being included in search results.

### Changes Implemented

#### 1. Keyword Extraction (src/rag/query_service.py)
Added `_extract_keywords()` method:
- Extracts meaningful keywords from user questions
- Filters out common stop words (the, what, when, where, who, why, how, give, me, brief, tell, show, find, search, query)
- Focuses on keywords with length > 2 characters
- Returns list of keywords for relevance checking

#### 2. Relevance Checking (src/rag/query_service.py)
Added `_is_email_relevant()` method:
- Checks if an email contains any of the extracted keywords
- Searches in both subject and body (with HTML stripped)
- Case-insensitive matching
- Returns True if email is relevant, False otherwise

#### 3. Thread Filtering (src/rag/query_service.py)
Enhanced thread retrieval to filter for relevance:
- When fetching all emails in a thread, only includes emails that match the search query
- Prevents irrelevant emails in the same conversation from being included
- Only adds threads that have at least one relevant email

#### 4. Citation Filtering (src/rag/query_service.py)
Updated `_build_citations()` method:
- Filters citations to only include relevant emails
- Uses keyword-based relevance check before adding to citations
- Cleans HTML from email snippets for better display
- Ensures citations only show emails that match the query

### Configuration Changes

No new environment variables required. Filtering is automatic and uses the same keywords extracted from the user's question.

### Benefits of Changes

1. **Accurate Citations**
   - Only emails that match the search query are shown
   - Eliminates false positives (e.g., "Test email" for "hepstar" queries)
   - Better user experience with relevant results only

2. **Improved Precision**
   - Keyword extraction focuses on meaningful terms
   - Stop word filtering reduces noise
   - Case-insensitive matching handles variations

3. **Thread-Aware Filtering**
   - Filters emails within threads, not just top-level results
   - Prevents irrelevant emails in same conversation from appearing
   - Maintains thread context while ensuring relevance

4. **Backward Compatible**
   - No breaking changes to existing functionality
   - Works with all existing queries
   - Automatic filtering requires no user configuration

### Testing Recommendations

1. Test with queries containing company names (e.g., "hepstar")
2. Verify irrelevant emails are excluded from citations
3. Test with multi-word queries to ensure keyword extraction works
4. Validate thread filtering excludes non-matching emails in conversations
5. Test with edge cases (empty keywords, very short queries)

### Known Limitations

1. Keyword extraction may miss some relevant emails if query uses synonyms
   - Future: Could add synonym expansion or semantic matching

2. Stop word list may need adjustment for domain-specific terms
   - Currently filters common English stop words
   - Can be extended if needed

### Files Modified
- src/rag/query_service.py

### Code Quality Notes
- All changes maintain backward compatibility
- Comprehensive error handling
- Type hints maintained
- Docstrings provided for all new methods
- Keyword extraction is case-insensitive and robust

-------------------------------------------------------------------------------
UPDATE: Wednesday, December 17, 2025 - 10:04 PM IST
-------------------------------------------------------------------------------

## Git Force Push to Main Branch

### Summary
Performed force push to main branch to reject incoming remote changes and overwrite remote repository with local state. All local changes were committed and pushed, overwriting 2 remote commits ("commit" and "env").

### Changes Implemented

#### 1. Local Changes Committed
Committed all uncommitted local changes before force push:
- Modified: data/emails.db, pyproject.toml
- Modified: src/GraphConnector.py, src/MongoDBHandler.py, src/SQLiteHandler.py
- Modified: src/SarvamClient.py, src/mcp_server.py
- Modified: src/rag/__init__.py, src/rag/mongo_vectors.py, src/rag/query_service.py
- Modified: src/web_api.py
- Modified: tests/__init__.py, tests/test_fts_search.py, tests/test_query_service.py
- Modified: tests/test_thread_rag.py, tests/test_vector_rerank.py
- Modified: web/.gitignore, web/app/email/[id]/page.tsx, web/app/globals.css
- Modified: web/app/page.tsx, web/next.config.js, web/package.json, web/tsconfig.json
- Added: C:/Users/ShreyesPrabhuDesai/PersProjects/central_Inteligence/data/emails.db
- Added: src/attachments/__init__.py, src/attachments/attachment_handler.py
- Added: src/attachments/chunking.py, src/attachments/document_extractors.py

Total: 28 files changed, 1592 insertions(+), 11 deletions(-)

#### 2. Force Push Operation
- Fetched latest from origin/main to identify incoming changes
- Identified 2 incoming commits on remote:
  - c47f79f: "commit"
  - 9fcd829: "env"
- Force pushed local main branch to origin/main
- Remote commits were rejected and overwritten
- Local commit: 1dae803 "Update: Local changes - rejecting incoming remote changes"

### Git Operations Performed

1. `git status` - Checked current branch and uncommitted changes
2. `git fetch origin` - Fetched latest remote state
3. `git log HEAD..origin/main` - Identified incoming commits
4. `git add -A` - Staged all changes
5. `git commit -m "Update: Local changes - rejecting incoming remote changes"` - Committed local changes
6. `git push --force origin main` - Force pushed to overwrite remote

### Result
- Remote main branch successfully overwritten with local state
- Incoming changes (commits c47f79f and 9fcd829) rejected as requested
- Local repository is now in sync with remote (local ahead)
- All local changes are now on remote main branch

### Notes
- Force push is a destructive operation that overwrites remote history
- All team members should be aware of this change
- If other team members have pulled the rejected commits, they will need to reset their local branches
- Future pulls may require `git pull --rebase` or `git reset --hard origin/main` for affected team members

### Files Affected
- All modified files in working directory (28 files)
- Remote main branch history

### Code Quality Notes
- Force push was performed as explicitly requested by user
- All local changes were properly committed before push
- Git history shows clean force update: + c47f79f...1dae803 main -> main (forced update)

-------------------------------------------------------------------------------
End of Update
-------------------------------------------------------------------------------


-------------------------------------------------------------------------------
UPDATE: Wednesday, December 17, 2025 - 10:50 PM IST
-------------------------------------------------------------------------------

## .msg File Support and Attachment Processing Enhancement

### Summary
Added comprehensive support for processing .msg (Outlook message) files and embedded email attachments. The system can now extract content from .msg files, process embedded email messages from Microsoft Graph API, and include attachment content in LLM queries.

### Changes Implemented

#### 1. .msg File Extractor (src/attachments/document_extractors.py)
Created MSGExtractor class:
- Uses extract-msg library to parse Outlook .msg files
- Extracts email metadata: subject, sender, recipients, date, body
- Handles both HTML and plain text email bodies
- Strips HTML tags for cleaner text extraction
- Supports embedded messages from Graph API (itemAttachments)
- Returns structured text format similar to email content

#### 2. Document Extractor Factory Enhancement
Updated DocumentExtractorFactory:
- Added support for .msg MIME types: application/vnd.ms-outlook, application/x-msg, message/rfc822
- Enhanced get_extractor() to detect file types by extension when MIME type is missing
- Updated is_supported() to check both MIME type and file extension
- Automatically detects .msg files even when contentType is None

#### 3. Graph API ItemAttachment Support (src/GraphConnector.py)
Enhanced attachment handling for embedded messages:
- Detects itemAttachment type from Graph API responses
- Attempts to find embedded messages by subject search in mailbox
- Extracts full message content (subject, sender, body, recipients)
- Falls back to subject-only content if message not found

#### 4. Query Service Attachment Integration (src/rag/query_service.py)
Updated to include attachment content in LLM context:
- Added _get_email_attachments() method to fetch attachments from SQLite
- Enhanced _build_thread_context() to include attachment content
- Attachments are included in context sent to LLM (up to 5 per email, 500 chars each)
- LLM can now answer questions based on attachment content

### Testing Results
- ✓ .msg files are detected and processed
- ✓ Embedded email messages (itemAttachments) are extracted
- ✓ Attachment content is included in query context
- ✓ LLM can answer questions about attachment content
- ✓ System successfully processes pardhasaradhi email with 7 attachments

### Files Modified
- src/attachments/document_extractors.py (added MSGExtractor)
- src/GraphConnector.py (added itemAttachment support)
- src/attachments/attachment_handler.py (enhanced type detection)
- src/rag/query_service.py (added attachment content to context)
- pyproject.toml (added extract-msg dependency)

-------------------------------------------------------------------------------
UPDATE: Wednesday, December 17, 2025 - 10:21 PM IST
-------------------------------------------------------------------------------

## Frontend Setup and Email Processing Configuration

### Summary
Set up the web application frontend on port 3050, fixed Graph API query issues, and ensured attachment processing is enabled for all emails including the latest from "parda".

### Changes Implemented

#### 1. Frontend Server Configuration
- Configured Next.js frontend to run on port 3050 (port 5000 was occupied by macOS AirPlay)
- Verified frontend is serving correctly at http://localhost:3050
- Backend API running on http://localhost:8000

#### 2. Environment Variables Setup
- Created .env file with all required configuration:
  - MONGODB_URI: MongoDB connection string
  - SQLITE_DB_PATH: Path to SQLite database
  - SARVAM_API_KEY: API key for Sarvam AI
  - EMAIL_ADDRESS: ci@zapcg.com
  - EMAIL_PASSWORD: App password for IMAP
  - COLLECTION_NAME: CIZAPCOM
  - IMAP_SERVER: outlook.office365.com
  - IMAP_PORT: 993
  - TENANT_ID, CLIENT_ID, CLIENT_SECRET: Microsoft Graph API credentials
  - PROCESS_ATTACHMENTS: true (enabled attachment processing)

#### 3. Graph API Query Fix (src/GraphConnector.py)
- Removed invalid 'inReplyTo' field from Graph API select queries
- Fixed both get_emails() and sync_all_emails() methods
- Graph API was returning 400 error due to invalid field selection
- Now successfully fetching emails with proper field selection

#### 4. Backend API Environment Loading (src/web_api.py)
- Added python-dotenv import and load_dotenv() call
- Backend now automatically loads .env file on startup
- Resolves issue where backend couldn't start due to missing environment variables

#### 5. Email Processing Verification
- Processed emails from last 30 days (2024-11-17 to 2025-12-17)
- Found 3 existing emails in database:
  - Fw: Notes about Hepstar (from Satamitra Ghosh Dastidar)
  - Fw: Technical Exploratory Call (from Satamitra Ghosh Dastidar)
  - Test email (from Shreyes Prabhu Desai)
- No emails from "parda" found in current database
- System is configured to process attachments when new emails arrive

### Configuration Changes

New Environment Variables:
- PROCESS_ATTACHMENTS=true (added to .env)

Fixed Issues:
- Graph API query now excludes invalid 'inReplyTo' field
- Backend API now loads .env file automatically
- Frontend running on port 3050 (avoiding port conflicts)

### Current Status

Email Database:
- 3 emails currently in database
- All emails processed with embeddings and analysis
- Attachment processing enabled for future emails
- No emails from "parda" found yet

System Readiness:
- Frontend: http://localhost:3050 (running)
- Backend: http://localhost:8000 (running)
- SQLite: Connected (3 emails)
- MongoDB: Connected (3 documents)
- Attachment processing: Enabled
- Graph API: Working correctly

### Next Steps for Parda Email

When the email from "parda" arrives:
1. System will automatically process it if PROCESS_ATTACHMENTS=true
2. Email will be stored in SQLite with all metadata
3. Attachments will be downloaded and processed
4. Email content and attachments will be chunked and embedded
5. Embeddings will be stored in MongoDB for search
6. Email will be marked as processed
7. System will be able to answer questions based on the email and attachments

To manually process new emails:
- Run: python src/run_process.py (with updated date range)
- Or use MCP tool: process_emails(start_date, end_date, [], None)

### Files Modified
- src/web_api.py (added dotenv loading)
- src/GraphConnector.py (fixed Graph API query)
- .env (created with all configuration)
- dev_documentation.txt (this update)

### Code Quality Notes
- All changes maintain backward compatibility
- Error handling preserved
- Environment variable loading is automatic
- Graph API queries now use valid field selections

### Deployment Checklist
- [x] Frontend running on port 3050
- [x] Backend running on port 8000
- [x] Environment variables configured
- [x] Graph API queries fixed
- [x] Attachment processing enabled
- [ ] Email from "parda" to be processed when received
- [ ] Verify attachments are processed correctly
- [ ] Test query system with parda email content

-------------------------------------------------------------------------------
End of Update
-------------------------------------------------------------------------------

